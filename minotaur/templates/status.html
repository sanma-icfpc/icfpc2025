<div id="status" class="space-y-6">
  <!-- Running Card -->
  <div class="bg-white border rounded p-4">
    <h3 class="font-semibold mb-2">Running</h3>
    {% if running %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
        <div><span class="text-gray-500">ticket:</span> <code>{{ running.ticket }}</code></div>
        <div><span class="text-gray-500">agent:</span> {{ running.agent_name or '-' }} <span class="text-gray-400">(id: {{ running.agent_id or '-' }})</span></div>
        <div><span class="text-gray-500">src:</span> {{ running.source_ip or '-' }}</div>
        <div><span class="text-gray-500">problem:</span> {{ running.problem_id }}</div>
        <div><span class="text-gray-500">lease:</span> {{ running.lease_expire_at }}</div>
      </div>
      <div class="mt-3">
        <button class="px-3 py-1 bg-red-600 text-white rounded" onclick="cancelRunning(event)">キャンセル</button>
      </div>
      <div class="mt-3">
        <h4 class="font-semibold text-sm mb-1">Requests</h4>
        <div class="text-xs bg-gray-50 border rounded p-2 max-h-64 overflow-auto">
          <div class="grid grid-cols-12 gap-2 font-mono text-gray-500 border-b pb-1 mb-1">
            <div class="col-span-4">時刻</div>
            <div class="col-span-2">リクエスト</div>
            <div class="col-span-4">進捗</div>
            <div class="col-span-2 text-right">コード</div>
          </div>
          {% for f in running_flows %}
            <div class="grid grid-cols-12 gap-2 items-center flow-row cursor-pointer" data-key="{{ f.req_key }}" onclick="this.classList.toggle('expanded'); this.nextElementSibling.classList.toggle('hidden')">
              <div class="col-span-4 rt" data-ts="{{ f.ts }}"></div>
              <div class="col-span-2">
                <div>{{ f.api }}</div>
                {% if f.summary %}<div class="text-gray-400">{{ f.summary }}</div>{% endif %}
              </div>
              <div class="col-span-4">
                <span class="{{ 'text-green-600' if 'agent_in' in f.phases else 'text-gray-400' }}">agent</span>
                → <span class="{{ 'text-green-600' if 'to_upstream' in f.phases else 'text-gray-400' }}">minotaur</span>
                → <span class="{{ 'text-green-600' if 'from_upstream' in f.phases else 'text-gray-400' }}">upstream</span>
                → <span class="{{ 'text-green-600' if 'agent_out' in f.phases else 'text-gray-400' }}">agent</span>
              </div>
              <div class="col-span-2 text-right">
                {% set c = f.codes %}
                <span class="{{ 'text-green-600' if c.get('from_upstream',0)==200 or c.get('agent_out',0)==200 else 'text-gray-600' }}">{{ c.get('from_upstream') or c.get('agent_out') or '' }}</span>
              </div>
            </div>
            <div class="hidden pl-4 text-gray-600">
              <div class="grid grid-cols-12 gap-2">
                <div class="col-span-6"><div class="text-gray-400">req</div><pre class="whitespace-pre-wrap">{{ f.req_pretty }}</pre></div>
                <div class="col-span-6"><div class="text-gray-400">res</div><pre class="whitespace-pre-wrap">{{ f.res_pretty }}</pre></div>
              </div>
            </div>
          {% else %}
            <div class="text-gray-400">No requests yet.</div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="text-sm text-gray-500">None</div>
    {% endif %}
  </div>

  <!-- Queued Cards -->
  <div class="bg-white border rounded p-4">
    <h3 class="font-semibold mb-2">Queued</h3>
    {% if queued %}
      <div class="grid grid-cols-1 gap-2">
        {% for t in queued %}
        <div class="border rounded p-2 text-sm">
          <div class="flex items-center justify-between">
            <div class="truncate">
              <div><span class="text-gray-500">ticket:</span> <code>{{ t.ticket }}</code></div>
              <div><span class="text-gray-500">agent:</span> {{ t.agent_name or '-' }} <span class="text-gray-400">(id: {{ t.agent_id or '-' }})</span></div>
              <div><span class="text-gray-500">src:</span> {{ t.source_ip or '-' }}</div>
              <div><span class="text-gray-500">problem:</span> {{ t.problem_id }}</div>
            </div>
            <div class="text-xs text-gray-600">prio {{ t.effective_priority }}</div>
          </div>
          <div class="mt-2 text-xs bg-gray-50 border rounded p-2">
            {% set flows = queued_flows.get(t.id) %}
            {% for f in flows %}
              <div class="grid grid-cols-12 gap-2 items-center flow-row cursor-pointer" data-key="{{ f.req_key }}" onclick="this.classList.toggle('expanded'); this.nextElementSibling.classList.toggle('hidden')">
                <div class="col-span-4 rt" data-ts="{{ f.ts }}"></div>
                <div class="col-span-2">
                  <div>{{ f.api }}</div>
                  {% if f.summary %}<div class="text-gray-400">{{ f.summary }}</div>{% endif %}
                </div>
                <div class="col-span-4">
                  <span class="{{ 'text-green-600' if 'agent_in' in f.phases else 'text-gray-400' }}">agent</span>
                  → <span class="{{ 'text-green-600' if 'to_upstream' in f.phases else 'text-gray-400' }}">minotaur</span>
                  → <span class="{{ 'text-green-600' if 'from_upstream' in f.phases else 'text-gray-400' }}">upstream</span>
                  → <span class="{{ 'text-green-600' if 'agent_out' in f.phases else 'text-gray-400' }}">agent</span>
                </div>
                <div class="col-span-2 text-right">
                  {% set c = f.codes %}
                  <span class="{{ 'text-green-600' if c.get('from_upstream',0)==200 or c.get('agent_out',0)==200 else 'text-gray-600' }}">{{ c.get('from_upstream') or c.get('agent_out') or '' }}</span>
                </div>
              </div>
              <div class="hidden pl-4 text-gray-600">
                <div class="grid grid-cols-12 gap-2">
                  <div class="col-span-6"><div class="text-gray-400">req</div><pre class="whitespace-pre-wrap">{{ f.req_pretty }}</pre></div>
                  <div class="col-span-6"><div class="text-gray-400">res</div><pre class="whitespace-pre-wrap">{{ f.res_pretty }}</pre></div>
                </div>
              </div>
            {% else %}
              <div class="text-gray-400">No requests yet.</div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-sm text-gray-500">None</div>
    {% endif %}
  </div>

  <!-- Recent Cards (Collapsible) -->
  <div class="bg-white border rounded p-4">
    {% set rc = recent|length %}
    <details>
      <summary class="cursor-pointer select-none"><span class="font-semibold">Recent</span> <span class="text-gray-500 text-sm">({{ rc }})</span></summary>
      <div class="mt-3">
        {% if recent %}
          <div class="grid grid-cols-1 gap-2">
            {% for t in recent %}
            <div class="border rounded p-2 text-sm">
              <div class="flex items-center justify-between">
                <div class="w-full truncate">
                  <div class="flex items-center flex-wrap gap-x-2">
                    <span class="text-gray-500">ticket:</span>
                    <code class="mr-2">{{ t.ticket }}</code>
                    <span class="badge badge-{{ t.status }}">{{ t.status }}</span>
                    <span class="ml-3 text-gray-500">problem:</span>
                    <span class="truncate">{{ t.problem_id }}</span>
                  </div>
                  <div class="mt-1 text-gray-700">
                    <span class="text-gray-500">agent:</span> {{ t.agent_name or '-' }} <span class="text-gray-400">(id: {{ t.agent_id or '-' }})</span>
                    <span class="ml-4 text-gray-500">src:</span> {{ t.source_ip or '-' }}
                  </div>
                </div>
              </div>
              <div class="mt-2">
                <h4 class="font-semibold text-xs mb-1">Request</h4>
                <div class="text-xs bg-gray-50 border rounded p-2">
                  {% set flows = recent_flows.get(t.id) %}
                  {% for f in flows %}
                    <div class="grid grid-cols-12 gap-2 items-center flow-row cursor-pointer" data-key="{{ f.req_key }}" onclick="this.classList.toggle('expanded'); this.nextElementSibling.classList.toggle('hidden')">
                      <div class="col-span-4 rt" data-ts="{{ f.ts }}"></div>
                      <div class="col-span-2">
                        <div>{{ f.api }}</div>
                        {% if f.summary %}<div class="text-gray-400">{{ f.summary }}</div>{% endif %}
                      </div>
                      <div class="col-span-4">
                        <span class="{{ 'text-green-600' if 'agent_in' in f.phases else 'text-gray-400' }}">agent</span>
                        → <span class="{{ 'text-green-600' if 'to_upstream' in f.phases else 'text-gray-400' }}">minotaur</span>
                        → <span class="{{ 'text-green-600' if 'from_upstream' in f.phases else 'text-gray-400' }}">upstream</span>
                        → <span class="{{ 'text-green-600' if 'agent_out' in f.phases else 'text-gray-400' }}">agent</span>
                      </div>
                      <div class="col-span-2 text-right">
                        {% set c = f.codes %}
                        <span class="{{ 'text-green-600' if c.get('from_upstream',0)==200 or c.get('agent_out',0)==200 else 'text-gray-600' }}">{{ c.get('from_upstream') or c.get('agent_out') or '' }}</span>
                      </div>
                    </div>
                    <div class="hidden pl-4 text-gray-600">
                      <div class="grid grid-cols-12 gap-2">
                        <div class="col-span-6"><div class="text-gray-400">req</div><pre class="whitespace-pre-wrap">{{ f.req_pretty }}</pre></div>
                        <div class="col-span-6"><div class="text-gray-400">res</div><pre class="whitespace-pre-wrap">{{ f.res_pretty }}</pre></div>
                      </div>
                    </div>
                  {% else %}
                    <div class="text-gray-400">No requests.</div>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-sm text-gray-500">None</div>
        {% endif %}
      </div>
    </details>
  </div>
</div>
