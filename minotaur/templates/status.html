<div id="status" class="space-y-6">
  <!-- Running Card -->
  <div id="section-running" class="bg-white border rounded p-4 relative">
    <h3 class="font-semibold mb-2">Running</h3>
    {% if running %}
      <div class="absolute top-2 right-2">
        <div class="w-8 h-8 rounded-md border overflow-hidden">
          <svg width="32" height="32" data-jdenticon-value="{{ running.agent_name or '*' }}"></svg>
        </div>
      </div>
      <div class="flex items-center flex-wrap gap-x-2 text-sm">
        <span class="badge badge-running">running</span>
        <span class="text-gray-500">problem:</span>
        <span class="truncate">{{ running.problem_id }}</span>
        <span class="ml-3 text-gray-500">agent:</span>
        {{ running.agent_name or '-' }} <span class="text-gray-400">(id: {{ running.agent_id or '-' }})</span>
      </div>
      <div class="mt-1 text-xs text-gray-600">
        <span class="text-gray-500">src:</span> {{ running.source_ip or '-' }}
        <span class="ml-4 text-gray-500">ticket:</span> <code>{{ running.ticket }}</code>
      </div>
      <div class="mt-3">
        <button class="px-3 py-1 bg-red-600 text-white rounded" onclick="cancelRunning(event)">Terminate</button>
      </div>
      <div class="mt-3">
        <h4 class="font-semibold text-sm mb-1">Requests</h4>
        <div class="text-xs bg-gray-50 border rounded p-2 max-h-64 overflow-auto">
          <div class="grid grid-cols-12 gap-2 font-mono text-gray-500 border-b pb-1 mb-1">
            <div class="col-span-4">時刻</div>
            <div class="col-span-2">リクエスト</div>
            <div class="col-span-4">進捗</div>
            <div class="col-span-2 text-right">コード</div>
          </div>
          {% for f in running_flows %}
            <div class="grid grid-cols-12 gap-2 items-center flow-row cursor-pointer" data-key="{{ f.req_key }}" onclick="this.classList.toggle('expanded'); this.nextElementSibling.classList.toggle('hidden'); (this.querySelectorAll ? this.querySelectorAll('.summary-inline').forEach(el=>el.classList.toggle('hidden')) : null)">
              <div class="col-span-4 rt" data-ts="{{ f.ts }}"></div>
              <div class="col-span-2">
                {% if f.api == 'event' %}
                  <div class="text-gray-500">(internal)</div>
                  {% if f.summary %}<div class="text-gray-400 summary-inline hidden">{{ f.summary }}</div>{% endif %}
                {% else %}
                  <div>/{{ f.api }}</div>
                  {% if f.summary %}<div class="text-gray-400 summary-inline hidden">{{ f.summary }}</div>{% endif %}
                {% endif %}
              </div>
              <div class="col-span-4">
                {% if f.api == 'event' %}
                  <span class="text-gray-600">{{ f.summary or '(internal)' }}</span>
                {% else %}
                  <span class="{{ 'text-green-600' if 'agent_in' in f.phases else 'text-gray-400' }}">agent</span>
                  → <span class="{{ 'text-green-600' if 'to_upstream' in f.phases else 'text-gray-400' }}">minotaur</span>
                  → <span class="{{ 'text-green-600' if 'from_upstream' in f.phases else 'text-gray-400' }}">upstream</span>
                  → <span class="{{ 'text-green-600' if 'agent_out' in f.phases else 'text-gray-400' }}">agent</span>
                {% endif %}
              </div>
              <div class="col-span-2 text-right">
                {% set c = f.codes %}
                <span class="{{ 'text-green-600' if c.get('from_upstream',0)==200 or c.get('agent_out',0)==200 else 'text-gray-600' }}">{{ c.get('from_upstream') or c.get('agent_out') or '' }}</span>
              </div>
            </div>
            <div class="hidden pl-4 text-gray-600">
              <div class="grid grid-cols-12 gap-2">
                {% if f.api != 'event' %}
                  <div class="col-span-6"><div class="text-gray-400">req</div><pre class="whitespace-pre-wrap">{{ f.req_pretty }}</pre></div>
                  <div class="col-span-6"><div class="text-gray-400">res</div><pre class="whitespace-pre-wrap">{{ f.res_pretty }}</pre></div>
                {% else %}
                  <div class="col-span-12 text-gray-500">(internal event)</div>
                {% endif %}
              </div>
            </div>
          {% else %}
            <div class="text-gray-400">No requests yet.</div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="text-sm text-gray-500">None</div>
    {% endif %}
  </div>

  <!-- Queued Cards -->
  <div id="section-queued" class="bg-white border rounded p-4">
    <h3 class="font-semibold mb-2">Queued</h3>
    {% if queued %}
      <div class="grid grid-cols-1 gap-2">
        {% for t in queued %}
        <div class="border rounded p-2 pr-12 text-sm relative">
          <div class="absolute top-2 right-2">
            <div class="w-7 h-7 rounded-md border overflow-hidden">
              <svg width="28" height="28" data-jdenticon-value="{{ t.agent_name or '*' }}"></svg>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center flex-wrap gap-x-2">
              <span class="badge badge-{{ t.status }}">{{ t.status }}</span>
              <span class="text-gray-500">problem:</span>
              <span class="truncate">{{ t.problem_id }}</span>
              <span class="ml-3 text-gray-500">agent:</span>
              {{ t.agent_name or '-' }} <span class="text-gray-400">(id: {{ t.agent_id or '-' }})</span>
              <span class="ml-3 text-gray-500">prio:</span>
              <span class="font-mono text-xs">{{ t.effective_priority }}</span>
            </div>
            <div class="text-xs text-gray-600">
              <button class="px-2 py-1 bg-red-600 text-white rounded" onclick="cancelQueued('{{ t.ticket }}'); return false;">Cancel</button>
            </div>
          </div>
          <div class="mt-1 text-xs text-gray-600">
            <span class="text-gray-500">src:</span> {{ t.source_ip or '-' }}
            <span class="ml-4 text-gray-500">ticket:</span> <code>{{ t.ticket }}</code>
          </div>
          <div class="mt-2 text-xs bg-gray-50 border rounded p-2">
            {% set flows = queued_flows.get(t.id) %}
            {% for f in flows %}
              <div class="grid grid-cols-12 gap-2 items-center flow-row cursor-pointer" data-key="{{ f.req_key }}" onclick="this.classList.toggle('expanded'); this.nextElementSibling.classList.toggle('hidden')">
                <div class="col-span-4 rt" data-ts="{{ f.ts }}"></div>
                <div class="col-span-2">
                  <div>/{{ f.api }}</div>
                  {% if f.summary %}<div class="text-gray-400">{{ f.summary }}</div>{% endif %}
                </div>
                <div class="col-span-4">
                  <span class="{{ 'text-green-600' if 'agent_in' in f.phases else 'text-gray-400' }}">agent</span>
                  → <span class="{{ 'text-green-600' if 'to_upstream' in f.phases else 'text-gray-400' }}">minotaur</span>
                  → <span class="{{ 'text-green-600' if 'from_upstream' in f.phases else 'text-gray-400' }}">upstream</span>
                  → <span class="{{ 'text-green-600' if 'agent_out' in f.phases else 'text-gray-400' }}">agent</span>
                </div>
                <div class="col-span-2 text-right">
                  {% set c = f.codes %}
                  <span class="{{ 'text-green-600' if c.get('from_upstream',0)==200 or c.get('agent_out',0)==200 else 'text-gray-600' }}">{{ c.get('from_upstream') or c.get('agent_out') or '' }}</span>
                </div>
              </div>
              <div class="hidden pl-4 text-gray-600">
                <div class="grid grid-cols-12 gap-2">
                  <div class="col-span-6"><div class="text-gray-400">req</div><pre class="whitespace-pre-wrap">{{ f.req_pretty }}</pre></div>
                  <div class="col-span-6"><div class="text-gray-400">res</div><pre class="whitespace-pre-wrap">{{ f.res_pretty }}</pre></div>
                </div>
              </div>
            {% else %}
              <div class="text-gray-400">No requests yet.</div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-sm text-gray-500">None</div>
    {% endif %}
  </div>

  <!-- Recent Cards -->
  <div id="section-recent" class="bg-white border rounded p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="flex items-center gap-3">
        <h3 class="font-semibold">Recent</h3>
        <div class="text-sm flex items-center gap-2">
          <input id="recent-filter-input" type="text" class="border rounded px-2 py-1 w-64" placeholder="Filter by agent or problem" value="{{ recent_filter or '' }}" />
        </div>
      </div>
      <div id="recent-pager" class="text-sm flex items-center gap-2" data-page="{{ recent_page or 1 }}" data-pages="{{ recent_pages or 1 }}">
        <button class="px-2 py-1 rounded bg-gray-200 disabled:opacity-50" onclick="recentPrev()" {% if (recent_page or 1) <= 1 %}disabled{% endif %}>Prev</button>
        <span class="text-gray-500">Page</span>
        <input id="recent-page-input" name="page" type="number" min="1" class="border rounded px-2 py-1 w-16 text-center" value="{{ recent_page or 1 }}" />
        <span class="text-gray-500">/ {{ recent_pages or 1 }}</span>
        <button class="px-2 py-1 rounded bg-gray-200 disabled:opacity-50" onclick="recentNext()" {% if (recent_page or 1) >= (recent_pages or 1) %}disabled{% endif %}>Next</button>
      </div>
    </div>
    <div class="mt-1">
      {% if recent %}
        <div class="grid grid-cols-1 gap-2">
          {% for t in recent %}
          <div class="border rounded p-2 text-sm relative">
              <div class="absolute top-2 right-2">
                <div class="w-7 h-7 rounded-md border overflow-hidden">
                  <svg width="28" height="28" data-jdenticon-value="{{ t.agent_name or '*' }}"></svg>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <div class="w-full truncate">
                  <div class="flex items-center flex-wrap gap-x-2">
                    <span class="badge badge-{{ t.status }}">{{ t.status }}</span>
                    <span class="text-gray-500">problem:</span>
                    <span class="truncate">{{ t.problem_id }}</span>
                    <span class="ml-3 text-gray-500">agent:</span>
                    {{ t.agent_name or '-' }} <span class="text-gray-400">(id: {{ t.agent_id or '-' }})</span>
                  </div>
                  <div class="mt-1 text-xs text-gray-600">
                    <span class="text-gray-500">src:</span> {{ t.source_ip or '-' }}
                    <span class="ml-4 text-gray-500">ticket:</span> <code>{{ t.ticket }}</code>
                  </div>
                </div>
              </div>
              <div class="mt-2">
                <div class="flex items-center gap-2 select-none cursor-pointer" data-recent-toggle="1" role="button" tabindex="0">
                  <h4 class="font-semibold text-xs mb-1">Request</h4>
                  <span class="text-gray-500 text-xs" data-caret>▸</span>
                </div>
                <div class="text-xs bg-gray-50 border rounded p-2 hidden" data-recent-requests>
                  {% set flows = recent_flows.get(t.id) %}
                  {% for f in flows %}
                    <div class="grid grid-cols-12 gap-2 items-center flow-row cursor-pointer" data-key="{{ f.req_key }}" onclick="this.classList.toggle('expanded'); this.nextElementSibling.classList.toggle('hidden'); (this.querySelectorAll ? this.querySelectorAll('.summary-inline').forEach(el=>el.classList.toggle('hidden')) : null)">
                      <div class="col-span-4 rt" data-ts="{{ f.ts }}"></div>
                      <div class="col-span-2">
                        {% if f.api == 'event' %}
                          <div class="text-gray-500">(internal)</div>
                          {% if f.summary %}<div class="text-gray-400 summary-inline hidden">{{ f.summary }}</div>{% endif %}
                        {% else %}
                          <div>/{{ f.api }}</div>
                          {% if f.summary %}<div class="text-gray-400 summary-inline hidden">{{ f.summary }}</div>{% endif %}
                        {% endif %}
                    </div>
                      <div class="col-span-4">
                        {% if f.api == 'event' %}
                          <span class="text-gray-600">{{ f.summary or '(internal)' }}</span>
                        {% else %}
                          <span class="{{ 'text-green-600' if 'agent_in' in f.phases else 'text-gray-400' }}">agent</span>
                          → <span class="{{ 'text-green-600' if 'to_upstream' in f.phases else 'text-gray-400' }}">minotaur</span>
                          → <span class="{{ 'text-green-600' if 'from_upstream' in f.phases else 'text-gray-400' }}">upstream</span>
                          → <span class="{{ 'text-green-600' if 'agent_out' in f.phases else 'text-gray-400' }}">agent</span>
                        {% endif %}
                      </div>
                      <div class="col-span-2 text-right">
                        {% set c = f.codes %}
                        <span class="{{ 'text-green-600' if c.get('from_upstream',0)==200 or c.get('agent_out',0)==200 else 'text-gray-600' }}">{{ c.get('from_upstream') or c.get('agent_out') or '' }}</span>
                      </div>
                    </div>
                    <div class="hidden pl-4 text-gray-600">
                      <div class="grid grid-cols-12 gap-2">
                        {% if f.api != 'event' %}
                          <div class="col-span-6"><div class="text-gray-400">req</div><pre class="whitespace-pre-wrap">{{ f.req_pretty }}</pre></div>
                          <div class="col-span-6"><div class="text-gray-400">res</div><pre class="whitespace-pre-wrap">{{ f.res_pretty }}</pre></div>
                        {% else %}
                          <div class="col-span-12 text-gray-500">(internal event)</div>
                        {% endif %}
                      </div>
                    </div>
                  {% else %}
                    <div class="text-gray-400">No requests.</div>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-sm text-gray-500">None</div>
      {% endif %}
    </div>
  </div>
</div>
