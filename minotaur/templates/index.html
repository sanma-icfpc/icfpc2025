{% extends "base.html" %}
{% block content %}
<div>
  <!-- Tabs -->
  <div class="mb-4 border-b">
    <nav class="flex gap-2 -mb-px" role="tablist" aria-label="Tabs">
      <button id="tabbtn-scheduler" onclick="switchTab('scheduler')" class="px-3 py-2 border-b-2 border-blue-600 text-blue-600">⚖️ Scheduler</button>
      <button id="tabbtn-running" onclick="switchTab('running')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">🏃 Running Agents</button>
      <button id="tabbtn-queued" onclick="switchTab('queued')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">⏳ Queued Agents</button>
      <button id="tabbtn-recent" onclick="switchTab('recent')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">📜 Recent Challenges</button>
      <button id="tabbtn-analytics" onclick="switchTab('analytics')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">📊Analytics</button>
      <button id="tabbtn-admin" onclick="switchTab('admin')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">🛡️ Admin</button>
    </nav>
  </div>

  <!-- Scheduler Tab -->
  <div id="tab-scheduler">
    <div id="scheduler-pane">Loading scheduler…</div>
  </div>

  <!-- Running Agents Tab -->
  <div id="tab-running" class="hidden">
    <div id="running-pane">Loading…</div>
  </div>

  <!-- Queued Agents Tab -->
  <div id="tab-queued" class="hidden">
    <div id="queued-pane">Loading…</div>
  </div>

  <!-- Recent Challenges Tab -->
  <div id="tab-recent" class="hidden">
    <div id="recent-pane">Loading…</div>
  </div>

  <!-- Analytics Tab -->
  <div id="tab-analytics" class="hidden">
    <div id="analytics-pane">Loading analytics…</div>
  </div>

  <!-- Admin Tab -->
  <div id="tab-admin" class="hidden">
    <div class="space-y-3">
      <div>
        <h2 class="font-semibold mb-2">設定</h2>
        <button class="px-3 py-1 bg-gray-800 text-white rounded" onclick="openModal()">設定を開く</button>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Database</h2>
        <div class="flex items-center gap-2">
          <button class="px-3 py-1 bg-gray-600 text-white rounded" onclick="downloadDB()">DL SQLite3</button>
          <span id="db-size" class="text-xs text-gray-500">—</span>
          <button class="ml-2 px-2 py-1 text-xs bg-gray-200 rounded" onclick="closeDbConns(); return false;">Close DB Conns</button>
          <button id="btn-db-conn-stats" class="px-2 py-1 text-xs bg-gray-200 rounded" onclick="queryDbConnCount(this); return false;">Open Conns: ?</button>
          <span id="db-conns" class="text-xs text-gray-500 ml-2">—</span>
        </div>
      </div>
      <div>
        <h2 class="font-semibold mb-2">File Descriptors</h2>
        <div id="fds-info" class="text-sm text-gray-700">
          —
        </div>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Memory</h2>
        <div class="text-sm text-gray-700 flex items-center gap-2 mb-1">
          <span id="mem-summary">—</span>
          <button class="ml-2 px-2 py-0.5 text-xs bg-gray-200 rounded" onclick="runGC(); return false;">Run GC</button>
          <button class="px-2 py-0.5 text-xs bg-gray-200 rounded" onclick="loadMemObjects(); return false;">Analyze Objects</button>
        </div>
        <div class="mt-1">
          <pre id="mem-json" class="p-2 bg-gray-50 border rounded text-xs overflow-auto max-h-48">—</pre>
        </div>
        <div class="mt-1">
          <pre id="mem-objects" class="p-2 bg-gray-50 border rounded text-xs overflow-auto max-h-48">(click "Analyze Objects")</pre>
        </div>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Server Threads</h2>
        <div class="text-sm text-gray-700 flex items-center gap-3">
          <span>Threads:</span>
          <span id="threads-count" class="font-mono">—</span>
          <span id="threads-states" class="text-xs text-gray-500"></span>
        </div>
        <div class="mt-2 text-xs text-gray-600">
          <div class="px-2 py-1 bg-gray-50 border border-b-0 rounded-t flex items-center gap-3 font-medium">
            <span class="w-16">ID</span>
            <span class="flex-1">Name / Meta</span>
            <span class="w-24">Status</span>
            <span class="w-20 text-right">Idle</span>
            <span class="w-20 text-right">CPU(s)</span>
          </div>
        </div>
        <div id="threads-list" class="max-h-72 overflow-auto border rounded-t-none rounded-b divide-y text-xs">
          <div class="p-2 text-gray-400">No data</div>
        </div>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Server</h2>
        <button class="px-3 py-1 bg-red-700 text-white rounded" onclick="shutdownServer(event)">サーバを終了</button>
      </div>
    </div>
  </div>
</div>

<script>
  let analyticsLoaded = false;
  let analyticsInFlight = false;
  let schedulerLoaded = false;
  let adminLoaded = false;
  function updateURLTab(name) {
    const url = new URL(window.location.href);
    url.searchParams.set('tab', name);
    try { window.history.replaceState({}, '', url.toString()); } catch (_) {}
  }
  function getURLTab() {
    try { return new URL(window.location.href).searchParams.get('tab') || ''; } catch (_) { return ''; }
  }
  function setActiveBtn(activeId) {
    const ids = ['tabbtn-scheduler','tabbtn-running','tabbtn-queued','tabbtn-recent','tabbtn-analytics','tabbtn-admin'];
    ids.forEach(id => {
      const btn = document.getElementById(id);
      if (!btn) return;
      if (id === activeId) btn.className = 'px-3 py-2 border-b-2 border-blue-600 text-blue-600';
      else btn.className = 'px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800';
    });
  }
  function switchTab(name) {
    const scheduler = document.getElementById('tab-scheduler');
    const running = document.getElementById('tab-running');
    const queued = document.getElementById('tab-queued');
    const recent = document.getElementById('tab-recent');
    const analytics = document.getElementById('tab-analytics');
    const admin = document.getElementById('tab-admin');
    const show = (el) => { el && el.classList.remove('hidden'); };
    const hide = (el) => { el && el.classList.add('hidden'); };
    if (name === 'running') {
      hide(queued); hide(recent); hide(scheduler); hide(analytics); hide(admin); show(running);
      setActiveBtn('tabbtn-running');
    } else if (name === 'queued') {
      hide(running); hide(recent); hide(scheduler); hide(analytics); hide(admin); show(queued);
      setActiveBtn('tabbtn-queued');
    } else if (name === 'recent') {
      hide(running); hide(queued); hide(scheduler); hide(analytics); hide(admin); show(recent);
      setActiveBtn('tabbtn-recent');
    } else if (name === 'analytics') {
      hide(running); hide(queued); hide(recent); hide(scheduler); hide(admin); show(analytics);
      setActiveBtn('tabbtn-analytics');
      if (!analyticsLoaded) loadAnalytics();
    } else if (name === 'admin') {
      hide(running); hide(queued); hide(recent); hide(scheduler); hide(analytics); show(admin);
      setActiveBtn('tabbtn-admin');
      if (!adminLoaded) loadAdminPane();
      // Refresh DB info when entering Admin
      refreshDBInfoIfVisible();
    } else { // default scheduler
      hide(running); hide(queued); hide(recent); hide(analytics); hide(admin); show(scheduler);
      setActiveBtn('tabbtn-scheduler');
      if (!schedulerLoaded) loadSchedulerPane();
    }
    updateURLTab(name);
  }
  function loadAnalytics() {
    if (analyticsInFlight) return;
    analyticsInFlight = true;
    fetch('/minotaur/pane_analytics', { credentials: 'same-origin' })
      .then(r => r.text())
      .then(html => {
        const el = document.getElementById('analytics-pane');
        if (el) el.innerHTML = html;
        analyticsLoaded = true;
      })
      .catch(() => {})
      .finally(() => { analyticsInFlight = false; });
  }

  function loadSchedulerPane() {
    const el = document.getElementById('tab-scheduler');
    if (!el) return;
    fetch('/minotaur/pane_scheduler', { credentials: 'same-origin' })
      .then(r => r.text())
      .then(html => {
        el.innerHTML = html;
        schedulerLoaded = true;
        try { loadPriorities(true); } catch (_) {}
        try { updateIdenticons(el); } catch (_) {}
      })
      .catch(() => {});
  }

  function loadAdminPane() {
    const el = document.getElementById('tab-admin');
    if (!el) return;
    fetch('/minotaur/pane_admin', { credentials: 'same-origin' })
      .then(r => r.text())
      .then(html => {
        el.innerHTML = html;
        adminLoaded = true;
        try { refreshDBInfoIfVisible(); } catch (_) {}
        try { refreshThreadsIfVisible(); } catch (_) {}
        try { refreshMemInfoIfVisible(); } catch (_) {}
      })
      .catch(() => {});
  }

  function refreshAnalyticsIfVisible() {
    const el = document.getElementById('tab-analytics');
    if (el && !el.classList.contains('hidden')) {
      // Only refresh after first load
      if (!analyticsLoaded) { loadAnalytics(); return; }
      loadAnalytics();
    }
  }

  function loadDBInfo() {
    const out = document.getElementById('db-size');
    if (!out) return;
    fetch('/minotaur/db_info', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        if (j && typeof j.sizeMB === 'number') {
          out.textContent = `size: ${j.sizeMB.toFixed(1)} MB`;
        } else if (j && j.in_memory) {
          out.textContent = '(in-memory DB)';
        } else {
          out.textContent = '—';
        }
      })
      .catch(() => { /* ignore */ });
  }

  function closeDbConns() {
    const btns = document.querySelectorAll('#tab-admin button');
    btns.forEach(b => b.disabled = true);
    fetch('/minotaur/db_close_conns', { method: 'POST', credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        try {
          const el = document.getElementById('db-conns');
          if (el && j && j.ok) {
            const gen = (typeof j.generation === 'number') ? j.generation : '?';
            const closedNow = (typeof j.closedNow === 'number') ? j.closedNow : 0;
            const reg = (typeof j.registry === 'number') ? j.registry : '?';
            el.textContent = `gen: ${gen} closedNow: ${closedNow} reg: ${reg}`;
          }
        } catch (_) {}
        // Refresh related diagnostics
        loadFDInfo();
        loadDBInfo();
        loadMemInfo();
      })
      .catch(() => {})
      .finally(() => { btns.forEach(b => b.disabled = false); });
  }

  function queryDbConnCount(btn) {
    if (!btn) btn = document.getElementById('btn-db-conn-stats');
    if (!btn) return;
    const label0 = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Open Conns: …';
    fetch('/minotaur/db_conn_stats', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        try {
          if (j && j.ok) {
            const n = (typeof j.count === 'number') ? j.count : '?';
            btn.textContent = `Open Conns: ${n}`;
          } else {
            btn.textContent = 'Open Conns: error';
          }
        } catch (_) { btn.textContent = 'Open Conns: error'; }
      })
      .catch(() => { btn.textContent = 'Open Conns: error'; })
      .finally(() => { btn.disabled = false; setTimeout(() => { /* keep result until next click */ }, 0); });
  }

  function loadFDInfo() {
    const out = document.getElementById('fds-info');
    if (!out) return;
    fetch('/minotaur/fd_info', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        try {
          if (j && j.error) { out.textContent = '—'; return; }
          // Build summary line
          const plat = (j && j.platform) ? String(j.platform) : '';
          const kind = (j && j.kind) ? String(j.kind) : 'fd';
          const open = (typeof j.open === 'number') ? j.open : null;
          const soft = (typeof j.soft === 'number') ? j.soft : null;
          const hard = (typeof j.hard === 'number') ? j.hard : null;
          let parts = [];
          if (open != null) parts.push(`${kind}: ${open}`);
          if (soft != null || hard != null) parts.push(`limit: ${soft != null ? soft : '?'} / ${hard != null ? hard : '?'}`);
          const summary = `${plat}: ${parts.join('  ')}`;
          // Render summary + full JSON details
          out.innerHTML = '<div id="fds-summary" class="mb-1"></div><pre id="fds-json" class="p-2 bg-gray-50 border rounded text-xs overflow-auto max-h-72"></pre>';
          const sumEl = out.querySelector('#fds-summary');
          const preEl = out.querySelector('#fds-json');
          if (sumEl) sumEl.textContent = summary;
          if (preEl) preEl.textContent = JSON.stringify(j, null, 2);
        } catch (_) { out.textContent = '—'; }
      })
      .catch(() => { const out2 = document.getElementById('fds-info'); if (out2) out2.textContent = '—'; });
  }

  function refreshDBInfoIfVisible() {
    const el = document.getElementById('tab-admin');
    if (el && !el.classList.contains('hidden')) {
      loadDBInfo();
      loadFDInfo();
    }
  }

  function loadMemInfo() {
    const sum = document.getElementById('mem-summary');
    const pre = document.getElementById('mem-json');
    if (!sum || !pre) return;
    fetch('/minotaur/mem_info', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        try {
          const rss = (typeof j.rssMB === 'number') ? `${j.rssMB.toFixed(1)} MB` : '—';
          const vms = (typeof j.vmsMB === 'number') ? `${j.vmsMB.toFixed(1)} MB` : '—';
          const th = (typeof j.threads === 'number') ? j.threads : (j.py_threads || '—');
          const gc = Array.isArray(j.py_gc) ? j.py_gc.join('/') : (j.py_gc || '');
          let parts = [];
          parts.push(`RSS: ${rss}`);
          if (typeof j.vmsMB === 'number') parts.push(`VMS: ${vms}`);
          if (th !== undefined) parts.push(`Threads: ${th}`);
          if (gc) parts.push(`GC: ${gc}`);
          sum.textContent = parts.join('   ');
          pre.textContent = JSON.stringify(j, null, 2);
        } catch (_) { sum.textContent = '—'; pre.textContent = '—'; }
      })
      .catch(() => { sum.textContent = '—'; pre.textContent = '—'; });
  }

  function refreshMemInfoIfVisible() {
    const el = document.getElementById('tab-admin');
    if (el && !el.classList.contains('hidden')) {
      loadMemInfo();
    }
  }

  function runGC() {
    const btns = document.querySelectorAll('#tab-admin button');
    btns.forEach(b => b.disabled = true);
    fetch('/minotaur/gc_collect', { method: 'POST', credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        try {
          const pre = document.getElementById('mem-json');
          if (pre) pre.textContent = JSON.stringify({ gcCollect: j }, null, 2);
          loadMemInfo();
        } catch (_) {}
      })
      .catch(() => {})
      .finally(() => { btns.forEach(b => b.disabled = false); });
  }

  function loadMemObjects() {
    const pre = document.getElementById('mem-objects');
    if (!pre) return;
    pre.textContent = '(collecting…)';
    fetch('/minotaur/mem_objects?limit=40', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        try {
          if (j && j.ok === false) {
            pre.textContent = 'error: ' + (j.error || 'unknown');
            return;
          }
          pre.textContent = JSON.stringify(j, null, 2);
        } catch (_) { pre.textContent = '(error)'; }
      })
      .catch(() => { pre.textContent = '(error)'; });
  }

  function loadThreadsInfo() {
    const cnt = document.getElementById('threads-count');
    const stat = document.getElementById('threads-states');
    const list = document.getElementById('threads-list');
    if (!cnt) return;
    fetch('/minotaur/threads_os', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        try {
          const threads = Array.isArray(j.threads) ? j.threads : [];
          cnt.textContent = String(threads.length || (j.summary && j.summary.count) || 0);
          if (stat) {
            const summary = j.summary || {};
            const keys = Object.keys(summary).filter(k => k !== 'count').sort();
            if (threads.length && keys.length) {
              stat.textContent = keys.map(k => `${k}:${summary[k]}`).join(' ');
            } else {
              stat.textContent = '';
            }
          }
          if (list) {
            if (!threads.length) { list.innerHTML = '<div class="p-2 text-gray-400">No data</div>'; return; }
            const rows = threads.map(t => {
              const id = (t.id != null) ? t.id : '-';
              const n = (t.py_name || t.name || '').toString();
              const st = (t.state || '').toString();
              const wchan = (t.wchan || '').toString();
              const kind = (t.statusKind || '').toString();
              const idle = (typeof t.idleForSec === 'number') ? t.idleForSec : 0;
              const idleStr = (kind === 'waiting' && idle > 0) ? `${idle.toFixed(1)}s` : '';
              const meta = [st ? st : null, wchan ? `w:${wchan}` : null].filter(Boolean).join(' ');
              const cpu = (typeof t.cpu_time_sec === 'number') ? t.cpu_time_sec : 0;
              const cpuStr = cpu ? cpu.toFixed(2) : '0.00';
              return `<div class="p-2 flex items-center gap-3">
                <span class="w-16 font-mono">${id}</span>
                <span class="flex-1 truncate">${n || '(unnamed)'}${meta ? ' — ' + meta : ''}</span>
                <span class="w-24 text-gray-700">${kind || ''}</span>
                <span class="w-20 text-gray-500 text-right">${idleStr}</span>
                <span class="w-20 text-gray-500 text-right">${cpuStr}</span>
              </div>`;
            }).join('');
            list.innerHTML = rows;
          }
        } catch (_) {
          if (cnt) cnt.textContent = '—';
          if (stat) stat.textContent = '';
          if (list) list.innerHTML = '<div class="p-2 text-gray-400">Error</div>';
        }
      })
      .catch(() => { if (cnt) cnt.textContent = '—'; if (stat) stat.textContent = ''; if (list) list.innerHTML = '<div class="p-2 text-gray-400">Error</div>'; });
  }

  function refreshThreadsIfVisible() {
    const el = document.getElementById('tab-admin');
    if (el && !el.classList.contains('hidden')) {
      loadThreadsInfo();
    }
  }
  // Activate from URL parameter on first load
  document.addEventListener('DOMContentLoaded', function() {
    const tab = getURLTab() || 'scheduler';
    switchTab(tab);
    if (tab === 'scheduler' && !schedulerLoaded) { loadSchedulerPane(); }
    // Preload DB info if Admin is the initial tab
    refreshDBInfoIfVisible();
    refreshThreadsIfVisible();
    refreshMemInfoIfVisible();
  });
</script>
{% endblock %}
