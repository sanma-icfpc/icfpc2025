{% extends "base.html" %}
{% block content %}
<div>
  <!-- Tabs -->
  <div class="mb-4 border-b">
    <nav class="flex gap-2 -mb-px" role="tablist" aria-label="Tabs">
      <button id="tabbtn-scheduler" onclick="switchTab('scheduler')" class="px-3 py-2 border-b-2 border-blue-600 text-blue-600">âš–ï¸ Scheduler</button>
      <button id="tabbtn-running" onclick="switchTab('running')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">ğŸƒ Running Agents</button>
      <button id="tabbtn-queued" onclick="switchTab('queued')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">â³ Queued Agents</button>
      <button id="tabbtn-recent" onclick="switchTab('recent')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">ğŸ“œ Recent Challenges</button>
      <button id="tabbtn-analytics" onclick="switchTab('analytics')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">ğŸ“ŠAnalytics</button>
      <button id="tabbtn-admin" onclick="switchTab('admin')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">ğŸ›¡ï¸ Admin</button>
    </nav>
  </div>

  <!-- Scheduler Tab -->
  <div id="tab-scheduler">
    <div id="priority-pane" class="mb-4">Loading prioritiesâ€¦</div>
  </div>

  <!-- Running Agents Tab -->
  <div id="tab-running" class="hidden">
    <div id="running-pane">Loadingâ€¦</div>
  </div>

  <!-- Queued Agents Tab -->
  <div id="tab-queued" class="hidden">
    <div id="queued-pane">Loadingâ€¦</div>
  </div>

  <!-- Recent Challenges Tab -->
  <div id="tab-recent" class="hidden">
    <div id="recent-pane">Loadingâ€¦</div>
  </div>

  <!-- Analytics Tab -->
  <div id="tab-analytics" class="hidden">
    <div id="analytics-pane">Loading analyticsâ€¦</div>
  </div>

  <!-- Admin Tab -->
  <div id="tab-admin" class="hidden">
    <div class="space-y-3">
      <div>
        <h2 class="font-semibold mb-2">è¨­å®š</h2>
        <button class="px-3 py-1 bg-gray-800 text-white rounded" onclick="openModal()">è¨­å®šã‚’é–‹ã</button>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Database</h2>
        <div class="flex items-center gap-2">
          <button class="px-3 py-1 bg-gray-600 text-white rounded" onclick="downloadDB()">DL SQLite3</button>
          <span id="db-size" class="text-xs text-gray-500">â€”</span>
        </div>
      </div>
      <div>
        <h2 class="font-semibold mb-2">File Descriptors</h2>
        <div id="fds-info" class="text-sm text-gray-700">â€”</div>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Server Threads</h2>
        <div class="text-sm text-gray-700 flex items-center gap-3">
          <span>Threads:</span>
          <span id="threads-count" class="font-mono">â€”</span>
          <span id="threads-states" class="text-xs text-gray-500"></span>
        </div>
        <div class="mt-2 text-xs text-gray-600">
          <div class="px-2 py-1 bg-gray-50 border border-b-0 rounded-t flex items-center gap-3 font-medium">
            <span class="w-16">ID</span>
            <span class="flex-1">Name / Meta</span>
            <span class="w-24">Status</span>
            <span class="w-20 text-right">Idle</span>
            <span class="w-20 text-right">CPU(s)</span>
          </div>
        </div>
        <div id="threads-list" class="max-h-72 overflow-auto border rounded-t-none rounded-b divide-y text-xs">
          <div class="p-2 text-gray-400">No data</div>
        </div>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Server</h2>
        <button class="px-3 py-1 bg-red-700 text-white rounded" onclick="shutdownServer(event)">ã‚µãƒ¼ãƒã‚’çµ‚äº†</button>
      </div>
    </div>
  </div>
</div>

<script>
  let analyticsLoaded = false;
  let analyticsInFlight = false;
  function updateURLTab(name) {
    const url = new URL(window.location.href);
    url.searchParams.set('tab', name);
    try { window.history.replaceState({}, '', url.toString()); } catch (_) {}
  }
  function getURLTab() {
    try { return new URL(window.location.href).searchParams.get('tab') || ''; } catch (_) { return ''; }
  }
  function setActiveBtn(activeId) {
    const ids = ['tabbtn-scheduler','tabbtn-running','tabbtn-queued','tabbtn-recent','tabbtn-analytics','tabbtn-admin'];
    ids.forEach(id => {
      const btn = document.getElementById(id);
      if (!btn) return;
      if (id === activeId) btn.className = 'px-3 py-2 border-b-2 border-blue-600 text-blue-600';
      else btn.className = 'px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800';
    });
  }
  function switchTab(name) {
    const scheduler = document.getElementById('tab-scheduler');
    const running = document.getElementById('tab-running');
    const queued = document.getElementById('tab-queued');
    const recent = document.getElementById('tab-recent');
    const analytics = document.getElementById('tab-analytics');
    const admin = document.getElementById('tab-admin');
    const show = (el) => { el && el.classList.remove('hidden'); };
    const hide = (el) => { el && el.classList.add('hidden'); };
    if (name === 'running') {
      hide(queued); hide(recent); hide(scheduler); hide(analytics); hide(admin); show(running);
      setActiveBtn('tabbtn-running');
    } else if (name === 'queued') {
      hide(running); hide(recent); hide(scheduler); hide(analytics); hide(admin); show(queued);
      setActiveBtn('tabbtn-queued');
    } else if (name === 'recent') {
      hide(running); hide(queued); hide(scheduler); hide(analytics); hide(admin); show(recent);
      setActiveBtn('tabbtn-recent');
    } else if (name === 'analytics') {
      hide(running); hide(queued); hide(recent); hide(scheduler); hide(admin); show(analytics);
      setActiveBtn('tabbtn-analytics');
      if (!analyticsLoaded) loadAnalytics();
    } else if (name === 'admin') {
      hide(running); hide(queued); hide(recent); hide(scheduler); hide(analytics); show(admin);
      setActiveBtn('tabbtn-admin');
      // Refresh DB info when entering Admin
      refreshDBInfoIfVisible();
    } else { // default scheduler
      hide(running); hide(queued); hide(recent); hide(analytics); hide(admin); show(scheduler);
      setActiveBtn('tabbtn-scheduler');
    }
    updateURLTab(name);
  }
  function loadAnalytics() {
    if (analyticsInFlight) return;
    analyticsInFlight = true;
    fetch('/minotaur/analytics', { credentials: 'same-origin' })
      .then(r => r.text())
      .then(html => {
        const el = document.getElementById('analytics-pane');
        if (el) el.innerHTML = html;
        analyticsLoaded = true;
      })
      .catch(() => {})
      .finally(() => { analyticsInFlight = false; });
  }

  function refreshAnalyticsIfVisible() {
    const el = document.getElementById('tab-analytics');
    if (el && !el.classList.contains('hidden')) {
      // Only refresh after first load
      if (!analyticsLoaded) { loadAnalytics(); return; }
      loadAnalytics();
    }
  }

  function loadDBInfo() {
    const out = document.getElementById('db-size');
    if (!out) return;
    fetch('/minotaur/db_info', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        if (j && typeof j.sizeMB === 'number') {
          out.textContent = `size: ${j.sizeMB.toFixed(1)} MB`;
        } else if (j && j.in_memory) {
          out.textContent = '(in-memory DB)';
        } else {
          out.textContent = 'â€”';
        }
      })
      .catch(() => { /* ignore */ });
  }

  function loadFDInfo() {
    const out = document.getElementById('fds-info');
    if (!out) return;
    fetch('/minotaur/fd_info', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        try {
          if (j && j.error) { out.textContent = 'â€”'; return; }
          const plat = (j && j.platform) ? String(j.platform) : '';
          const kind = (j && j.kind) ? String(j.kind) : 'fd';
          const open = (typeof j.open === 'number') ? j.open : null;
          const soft = (typeof j.soft === 'number') ? j.soft : null;
          const hard = (typeof j.hard === 'number') ? j.hard : null;
          let parts = [];
          if (open != null) parts.push(`${kind}: ${open}`);
          if (soft != null || hard != null) parts.push(`limit: ${soft != null ? soft : '?'} / ${hard != null ? hard : '?'}`);
          if (!parts.length) { parts = ['â€”']; }
          out.textContent = `${plat}: ${parts.join('  ')}`;
        } catch (_) { out.textContent = 'â€”'; }
      })
      .catch(() => { const out2 = document.getElementById('fds-info'); if (out2) out2.textContent = 'â€”'; });
  }

  function refreshDBInfoIfVisible() {
    const el = document.getElementById('tab-admin');
    if (el && !el.classList.contains('hidden')) {
      loadDBInfo();
      loadFDInfo();
    }
  }

  function loadThreadsInfo() {
    const cnt = document.getElementById('threads-count');
    const stat = document.getElementById('threads-states');
    const list = document.getElementById('threads-list');
    if (!cnt) return;
    fetch('/minotaur/threads_os', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(j => {
        try {
          const threads = Array.isArray(j.threads) ? j.threads : [];
          cnt.textContent = String(threads.length || (j.summary && j.summary.count) || 0);
          if (stat) {
            const summary = j.summary || {};
            const keys = Object.keys(summary).filter(k => k !== 'count').sort();
            if (threads.length && keys.length) {
              stat.textContent = keys.map(k => `${k}:${summary[k]}`).join(' ');
            } else {
              stat.textContent = '';
            }
          }
          if (list) {
            if (!threads.length) { list.innerHTML = '<div class="p-2 text-gray-400">No data</div>'; return; }
            const rows = threads.map(t => {
              const id = (t.id != null) ? t.id : '-';
              const n = (t.py_name || t.name || '').toString();
              const st = (t.state || '').toString();
              const wchan = (t.wchan || '').toString();
              const kind = (t.statusKind || '').toString();
              const idle = (typeof t.idleForSec === 'number') ? t.idleForSec : 0;
              const idleStr = (kind === 'waiting' && idle > 0) ? `${idle.toFixed(1)}s` : '';
              const meta = [st ? st : null, wchan ? `w:${wchan}` : null].filter(Boolean).join(' ');
              const cpu = (typeof t.cpu_time_sec === 'number') ? t.cpu_time_sec : 0;
              const cpuStr = cpu ? cpu.toFixed(2) : '0.00';
              return `<div class="p-2 flex items-center gap-3">
                <span class="w-16 font-mono">${id}</span>
                <span class="flex-1 truncate">${n || '(unnamed)'}${meta ? ' â€” ' + meta : ''}</span>
                <span class="w-24 text-gray-700">${kind || ''}</span>
                <span class="w-20 text-gray-500 text-right">${idleStr}</span>
                <span class="w-20 text-gray-500 text-right">${cpuStr}</span>
              </div>`;
            }).join('');
            list.innerHTML = rows;
          }
        } catch (_) {
          if (cnt) cnt.textContent = 'â€”';
          if (stat) stat.textContent = '';
          if (list) list.innerHTML = '<div class="p-2 text-gray-400">Error</div>';
        }
      })
      .catch(() => { if (cnt) cnt.textContent = 'â€”'; if (stat) stat.textContent = ''; if (list) list.innerHTML = '<div class="p-2 text-gray-400">Error</div>'; });
  }

  function refreshThreadsIfVisible() {
    const el = document.getElementById('tab-admin');
    if (el && !el.classList.contains('hidden')) {
      loadThreadsInfo();
    }
  }
  // Activate from URL parameter on first load
  document.addEventListener('DOMContentLoaded', function() {
    const tab = getURLTab() || 'scheduler';
    switchTab(tab);
    // Preload DB info if Admin is the initial tab
    refreshDBInfoIfVisible();
    refreshThreadsIfVisible();
  });
</script>
{% endblock %}
