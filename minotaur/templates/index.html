{% extends "base.html" %}
{% block content %}
<div>
  <!-- Tabs -->
  <div class="mb-4 border-b">
    <nav class="flex gap-2 -mb-px" role="tablist" aria-label="Tabs">
      <button id="tabbtn-scheduler" onclick="switchTab('scheduler')" class="px-3 py-2 border-b-2 border-blue-600 text-blue-600">Scheduler</button>
      <button id="tabbtn-challenges" onclick="switchTab('challenges')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">Challenges</button>
      <button id="tabbtn-analytics" onclick="switchTab('analytics')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">Analytics</button>
      <button id="tabbtn-admin" onclick="switchTab('admin')" class="px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">Admin</button>
    </nav>
  </div>

  <!-- Scheduler Tab -->
  <div id="tab-scheduler">
    <div id="priority-pane" class="mb-4">Loading priorities…</div>
  </div>

  <!-- Challenges Tab -->
  <div id="tab-challenges" class="hidden">
    <div id="status">Loading...</div>
    <!-- content will be injected by loadStatus() via SSE or initial load -->
  </div>

  <!-- Analytics Tab -->
  <div id="tab-analytics" class="hidden">
    <div id="analytics-pane">Loading analytics…</div>
  </div>

  <!-- Admin Tab -->
  <div id="tab-admin" class="hidden">
    <div class="space-y-3">
      <div>
        <h2 class="font-semibold mb-2">設定</h2>
        <button class="px-3 py-1 bg-gray-800 text-white rounded" onclick="openModal()">設定を開く</button>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Database</h2>
        <button class="px-3 py-1 bg-gray-600 text-white rounded" onclick="downloadDB()">DL SQLite3</button>
      </div>
      <div>
        <h2 class="font-semibold mb-2">Server</h2>
        <button class="px-3 py-1 bg-red-700 text-white rounded" onclick="shutdownServer(event)">サーバを終了</button>
      </div>
    </div>
  </div>
</div>

<script>
  let analyticsLoaded = false;
  function updateURLTab(name) {
    const url = new URL(window.location.href);
    url.searchParams.set('tab', name);
    try { window.history.replaceState({}, '', url.toString()); } catch (_) {}
  }
  function getURLTab() {
    try { return new URL(window.location.href).searchParams.get('tab') || ''; } catch (_) { return ''; }
  }
  function setActiveBtn(activeId) {
    const ids = ['tabbtn-scheduler','tabbtn-challenges','tabbtn-analytics','tabbtn-admin'];
    ids.forEach(id => {
      const btn = document.getElementById(id);
      if (!btn) return;
      if (id === activeId) btn.className = 'px-3 py-2 border-b-2 border-blue-600 text-blue-600';
      else btn.className = 'px-3 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800';
    });
  }
  function switchTab(name) {
    const scheduler = document.getElementById('tab-scheduler');
    const challenges = document.getElementById('tab-challenges');
    const analytics = document.getElementById('tab-analytics');
    const admin = document.getElementById('tab-admin');
    const show = (el) => { el && el.classList.remove('hidden'); };
    const hide = (el) => { el && el.classList.add('hidden'); };
    if (name === 'challenges') {
      hide(scheduler); hide(analytics); hide(admin); show(challenges);
      setActiveBtn('tabbtn-challenges');
    } else if (name === 'analytics') {
      hide(scheduler); hide(challenges); hide(admin); show(analytics);
      setActiveBtn('tabbtn-analytics');
      if (!analyticsLoaded) loadAnalytics();
    } else if (name === 'admin') {
      hide(scheduler); hide(challenges); hide(analytics); show(admin);
      setActiveBtn('tabbtn-admin');
    } else { // default scheduler
      hide(challenges); hide(analytics); hide(admin); show(scheduler);
      setActiveBtn('tabbtn-scheduler');
    }
    updateURLTab(name);
  }
  function loadAnalytics() {
    fetch('/minotaur/analytics', { credentials: 'same-origin' })
      .then(r => r.text())
      .then(html => {
        const el = document.getElementById('analytics-pane');
        el.innerHTML = html;
        analyticsLoaded = true;
      })
      .catch(() => {});
  }
  // Activate from URL parameter on first load
  document.addEventListener('DOMContentLoaded', function() {
    const tab = getURLTab() || 'scheduler';
    switchTab(tab);
  });
</script>
{% endblock %}
